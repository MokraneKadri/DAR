package fr.upmc.dar.dao;
import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.NamedQuery;
import javax.persistence.NoResultException;
import javax.persistence.Persistence;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;

import fr.upmc.dar.dao.interfaces.IUserDao;
import fr.upmc.dar.entities.User;
import fr.upmc.dar.enums.LoginType;


public class UserDao implements IUserDao{


	//static EntityManagerFactory emf = Persistence.createEntityManagerFactory("DAR");
	//static EntityManager em = emf.createEntityManager();
	@NamedQuery(name="finduser", query="")
	private static final String SELECT_BY_EMAIL = "SELECT u FROM User u WHERE u.eMail=:email";
	private static final String PARAM_EMAIL           = "email";

	private static final String SELECT_BY_USERNAME = "SELECT u FROM User u WHERE u.userName=:username ";
	private static final String PARAM_USERNAME           = "username";
	
	private static final String SELECT_BY_USERNAME_AND_PASSWORD = "SELECT u FROM User u WHERE u.userName=:username"
			+ "													 AND u.password=:password";
	private static final String SELECT_BY_EMAIL_AND_PASSWORD = "SELECT u FROM User u WHERE u.eMail=:email"
			+ "													 AND u.password=:password";
	private static final String PARAM_PASS           = "username";
	

	private EntityManagerFactory emf = Persistence.createEntityManagerFactory("DAR");
	
   @PersistenceContext(unitName="DAR")
	private  EntityManager  em ;
	
	

	// Injection du manager, qui s'occupe de la connexion avec la BDD




	public  UserDao() {
		
		if(em==null)
		em= emf.createEntityManager()  ;
	}







	// Enregistrement d'un nouvel utilisateur
	public void createUser( User utilisateur ) throws Exception {
		try {
			em.getTransaction().begin();
			em.persist( utilisateur );
			em.getTransaction().commit();
			
		} catch ( Exception e ) {
			System.out.println(e.getMessage());
			throw new Exception( e );
		}
	}



	// Recherche d'un utilisateur à partir de son adresse email
	public User findUserByEmail( String email ) throws Exception {
		User utilisateur = null;
		Query requete = em.createQuery( SELECT_BY_EMAIL );
		requete.setParameter( PARAM_EMAIL, email );
		try {
			utilisateur = (User) requete.getSingleResult();
		} catch ( NoResultException e ) {
			return null;
		} catch ( Exception e ) {
			throw new Exception( e );
		}
		return utilisateur;
	}

	// Recherche d'un utilisateur à partir de son adresse email
	public User findUserByUserName( String username ) throws Exception {
		User utilisateur = null;
		Query requete = em.createQuery( SELECT_BY_USERNAME );
		requete.setParameter( PARAM_USERNAME, username );
		try {
			utilisateur = (User) requete.getSingleResult();
		} catch ( NoResultException e ) {
			return null;
		} catch ( Exception e ) {
			throw new Exception( e );
		}
		return utilisateur;
	}

	public User findUserByCredantials( String login,String passwd,LoginType mailOrUserName) throws Exception {
		User utilisateur = null;
		if(mailOrUserName==LoginType.EMAIL)
		Query requete = em.createQuery( SELECT_BY_EMAIL_AND_PASSWORD );
		requete.setp
		else 
		Query requete = em.createQuery( SELECT_BY_USERNAME_AND_PASSWORD);
		requete.setParameter( PARAM_EMAIL, login ,PARAM_PASS,passwd);
		try {
			utilisateur = (User) requete.getSingleResult();
		} catch ( NoResultException e ) {
			return null;
		} catch ( Exception e ) {
			throw new Exception( e );
		}
		return utilisateur;
	}


}
